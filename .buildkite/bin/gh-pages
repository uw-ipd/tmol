#!/bin/bash
#http://redsymbol.net/articles/unofficial-bash-strict-mode/

set -x
set -euo pipefail
IFS=$'\n\t'


docs/update-gh-pages


if [ "${BUILDKITE_BRANCH:-}" == "master" ]
then
  echo "--- git push gh-pages"
  pushd docs/_build/gh-pages
  git push origin

  ### Workaround for pages api access errors with agent app
  #
  # See comments in https://github.com/uw-ipd/tmol/pull/88
  #
  # Make a direct call to the pages build api endpoint using
  # a user oauth token provisioned for @asford.
  # @file syntax for -H requires curl > 7.55.0
  #
  # If running *out* of CI then just push with user credentials,
  # which should trigger a proper pages build.
  #
  # In case of error/testing run curl below but with `-u` based user
  # auth, rather than token auth.

  # Run curl capturing output of -w "%{http_code}" into HTTP_STATUS and send
  # the content to this command's STDOUT with -o >(cat >&3)

  exec 3>&1 
  HTTP_STATUS=$( \
    curl -w "%{http_code}" -o >(cat >&3) -i \
    -H @/buildkite-secrets/github-oauth-headers \
    -H "Accept: application/vnd.github.mister-fantastic-preview+json" \
    -H "Accept: application/vnd.github.machine-man-preview+json" \
    -X POST https://api.github.com/repos/uw-ipd/tmol/pages/builds \
  )
  [ "$HTTP_STATUS" == "201" ] || exit 1

fi
