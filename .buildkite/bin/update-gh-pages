#!/bin/bash

set -x
set -e

echo --- Clean gh-pages
# -ff clean to remove untracked subrepositories
git clean -xdff -- gh-pages

echo --- Clone gh-pages into subpath
# Checkout gh-pages
git clone -n --reference . --single-branch -b gh-pages `git config remote.origin.url` gh-pages

echo --- Copy html docs to gh-pages
# subshell to contain dotglob
(
  shopt -s dotglob
  cp -r docs/build/html/* gh-pages/
)

echo --- Commit pages changes
# Copy authorship information from current commit
export GIT_AUTHOR_NAME=`git show -s --format="%aN" HEAD`
export GIT_AUTHOR_EMAIL=`git show -s --format="%aE" HEAD`
export GIT_COMMITTER_NAME=buildkite
export GIT_COMMITTER_EMAIL=`git show -s --format="%aE" HEAD`
export HEAD_REF=`git rev-parse --abbrev-ref HEAD`
export HEAD_SHA=`git rev-parse --verify HEAD`
export HEAD_DESCR=`git describe --tags --dirty`

pushd gh-pages
git add .
# Reuse source commit authorship via -c
git commit -F - <<COMMIT
buildkite/bin/update-gh-pages at ${HEAD_DESCR} (${HEAD_REF})

source: ${HEAD_SHA}
COMMIT

popd

for i in "$@"
do
case $i in
    push)
      echo --- Push gh-pages
      pushd gh-pages
      git push origin
      popd
    ;;
    *)
      echo unknown option: $i
    ;;
esac
done
