version: 2
jobs:
  build:
    docker:
      - image: continuumio/miniconda3
    working_directory: ~/workspace
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "environment.yml" }}
            - v1-dependencies-
      - run:
          name: Install dependencies.
          command: |
            conda info -a
            conda config --set always_yes yes --set changeps1 no
            conda env update -f environment.yml
            source activate tmol
            pip install -r requirements.tests.txt
            conda clean -tipsy
      - save_cache:
          paths:
            - /opt/conda/pkgs
            - ~/.conda/pkgs
          key: v1-dependencies-{{ checksum "environment.yml" }}
      - run:
          name: Run tests.
          command: |
            source activate tmol
            mkdir -p report
            conda info -a | tee report/conda_info.log
            pytest 2>&1 | tee report/pytest.log
            
      - store_artifacts:
          path: report
          destination: report
